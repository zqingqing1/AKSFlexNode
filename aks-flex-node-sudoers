# Sudoers configuration for AKS Flex Node service
# This file grants the aks-flex-node service user specific sudo permissions
# needed for Kubernetes node operations, following principle of least privilege

# Azure Arc agent management (required for Arc machine registration)
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/azcmagent connect *
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/azcmagent disconnect *
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/azcmagent show *
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/azcmagent logs *
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/azcmagent *

# System service management (required for kubelet, containerd, CNI services)
aks-flex-node ALL=(root) NOPASSWD:SETENV: /bin/systemctl daemon-reload
aks-flex-node ALL=(root) NOPASSWD:SETENV: /bin/systemctl enable kubelet
aks-flex-node ALL=(root) NOPASSWD:SETENV: /bin/systemctl enable containerd
aks-flex-node ALL=(root) NOPASSWD:SETENV: /bin/systemctl enable --now kubelet
aks-flex-node ALL=(root) NOPASSWD:SETENV: /bin/systemctl enable --now containerd
aks-flex-node ALL=(root) NOPASSWD:SETENV: /bin/systemctl disable kubelet
aks-flex-node ALL=(root) NOPASSWD:SETENV: /bin/systemctl disable containerd
aks-flex-node ALL=(root) NOPASSWD:SETENV: /bin/systemctl start kubelet
aks-flex-node ALL=(root) NOPASSWD:SETENV: /bin/systemctl start containerd
aks-flex-node ALL=(root) NOPASSWD:SETENV: /bin/systemctl stop kubelet
aks-flex-node ALL=(root) NOPASSWD:SETENV: /bin/systemctl stop containerd
aks-flex-node ALL=(root) NOPASSWD:SETENV: /bin/systemctl restart kubelet
aks-flex-node ALL=(root) NOPASSWD:SETENV: /bin/systemctl restart containerd
aks-flex-node ALL=(root) NOPASSWD:SETENV: /bin/systemctl status kubelet
aks-flex-node ALL=(root) NOPASSWD:SETENV: /bin/systemctl status containerd
aks-flex-node ALL=(root) NOPASSWD:SETENV: /bin/systemctl check kubelet
aks-flex-node ALL=(root) NOPASSWD:SETENV: /bin/systemctl check containerd
aks-flex-node ALL=(root) NOPASSWD:SETENV: /bin/systemctl is-active *
aks-flex-node ALL=(root) NOPASSWD:SETENV: /bin/systemctl is-enabled *
aks-flex-node ALL=(root) NOPASSWD:SETENV: /bin/systemctl list-unit-files *
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/systemctl daemon-reload
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/systemctl enable kubelet
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/systemctl enable containerd
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/systemctl enable --now kubelet
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/systemctl enable --now containerd
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/systemctl disable kubelet
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/systemctl disable containerd
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/systemctl start kubelet
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/systemctl start containerd
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/systemctl stop kubelet
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/systemctl stop containerd
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/systemctl restart kubelet
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/systemctl restart containerd
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/systemctl status kubelet
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/systemctl status containerd
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/systemctl check kubelet
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/systemctl check containerd
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/systemctl is-active *
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/systemctl is-enabled *
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/systemctl list-unit-files *

# Package management (for installing Kubernetes components)
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/apt-get update
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/apt-get install -y apt-transport-https ca-certificates curl gpg
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/apt-get install -y kubelet kubeadm kubectl containerd
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/apt-get remove -y kubelet kubeadm kubectl containerd runc
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/apt-mark hold kubelet kubeadm kubectl
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/apt-mark unhold kubelet kubeadm kubectl

# Directory and file operations for Kubernetes paths - simplified for compatibility
aks-flex-node ALL=(root) NOPASSWD:SETENV: /bin/mkdir *, /usr/bin/mkdir *
aks-flex-node ALL=(root) NOPASSWD:SETENV: /bin/mkdir -p /etc/kubernetes/*, /bin/mkdir -p /var/lib/kubelet/*, /bin/mkdir -p /var/lib/cni/*, /bin/mkdir -p /etc/containerd/*, /bin/mkdir -p /opt/cni/bin, /bin/mkdir -p /etc/cni/net.d, /bin/mkdir -p /etc/systemd/system/kubelet.service.d, /bin/mkdir -p /etc/sysctl.d, /bin/mkdir -p /etc/modules-load.d
aks-flex-node ALL=(root) NOPASSWD:SETENV: /bin/cp *, /bin/mv *, /bin/rm *
aks-flex-node ALL=(root) NOPASSWD:SETENV: /bin/chmod *, /bin/chown *
aks-flex-node ALL=(root) NOPASSWD:SETENV: /bin/ln *, /usr/bin/ln *
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/install *, /bin/install *
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/curl *, /usr/bin/wget *
aks-flex-node ALL=(root) NOPASSWD:SETENV: /bin/tar *, /usr/bin/unzip *
aks-flex-node ALL=(root) NOPASSWD:SETENV: /bin/ls *, /usr/bin/ls *
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/test *, /bin/test *

# System configuration for Kubernetes
aks-flex-node ALL=(root) NOPASSWD:SETENV: /sbin/sysctl --system
aks-flex-node ALL=(root) NOPASSWD:SETENV: /sbin/modprobe overlay
aks-flex-node ALL=(root) NOPASSWD:SETENV: /sbin/modprobe br_netfilter

# Configuration file management and reading
aks-flex-node ALL=(root) NOPASSWD:SETENV: /bin/tee /etc/sysctl.d/k8s.conf
aks-flex-node ALL=(root) NOPASSWD:SETENV: /bin/tee /etc/modules-load.d/k8s.conf
aks-flex-node ALL=(root) NOPASSWD:SETENV: /bin/tee /etc/containerd/config.toml
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/cat /etc/default/kubelet
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/cat /etc/systemd/system/kubelet.service
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/cat /etc/systemd/system/kubelet.service.d/*
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/cat /etc/kubernetes/*
aks-flex-node ALL=(root) NOPASSWD:SETENV: /bin/cat /etc/default/kubelet
aks-flex-node ALL=(root) NOPASSWD:SETENV: /bin/cat /etc/systemd/system/kubelet.service
aks-flex-node ALL=(root) NOPASSWD:SETENV: /bin/cat /etc/systemd/system/kubelet.service.d/*
aks-flex-node ALL=(root) NOPASSWD:SETENV: /bin/cat /etc/kubernetes/*

# Network operations for troubleshooting
aks-flex-node ALL=(root) NOPASSWD:SETENV: /sbin/ip route
aks-flex-node ALL=(root) NOPASSWD:SETENV: /sbin/ip addr
aks-flex-node ALL=(root) NOPASSWD:SETENV: /bin/netstat -rn

# Read-only Kubernetes API check for node readiness (used by status collector)
# This is intentionally limited to 'get node' with the kubelet kubeconfig.
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/kubectl --kubeconfig /var/lib/kubelet/kubeconfig get node *
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/local/bin/kubectl --kubeconfig /var/lib/kubelet/kubeconfig get node *

# Note: Arc agent (azcmagent) is managed by install.sh and should not be removed during unbootstrap
# Unbootstrap only cleans up what AKS Flex Node created, not the underlying Arc installation

# Mount/unmount operations for cleanup
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/umount -l /var/lib/kubelet
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/umount -l *
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/mountpoint *
aks-flex-node ALL=(root) NOPASSWD:SETENV: /usr/bin/find * -delete
aks-flex-node ALL=(root) NOPASSWD:SETENV: /bin/rmdir *